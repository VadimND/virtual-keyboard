const en = [
    {
        small: '`',
        shift: '~',
        code: 'Backquote',
    },
    {
        small: '1',
        shift: '!',
        code: 'Digit1',
    },
    {
        small: '2',
        shift: '@',
        code: 'Digit2',
    },
    {
        small: '3',
        shift: '#',
        code: 'Digit3',
    },
    {
        small: '4',
        shift: '$',
        code: 'Digit4',
    },
    {
        small: '5',
        shift: '%',
        code: 'Digit5',
    },
    {
        small: '6',
        shift: '^',
        code: 'Digit6',
    },
    {
        small: '7',
        shift: '&',
        code: 'Digit7',
    },
    {
        small: '8',
        shift: '*',
        code: 'Digit8',
    },
    {
        small: '9',
        shift: '(',
        code: 'Digit9',
    },
    {
        small: '0',
        shift: ')',
        code: 'Digit0',
    },
    {
        small: '-',
        shift: '_',
        code: 'Minus',
    },
    {
        small: '=',
        shift: '+',
        code: 'Equal',
    },
    {
        small: 'Backspace',
        shift: null,
        code: 'Backspace',
    },
    {
        small: 'Delete',
        shift: null,
        code: 'Delete',
    },
    {
        small: 'Tab',
        shift: null,
        code: 'Tab',
    },
    {
        small: 'q',
        shift: 'Q',
        code: 'KeyQ',
    },
    {
        small: 'w',
        shift: 'W',
        code: 'KeyW',
    },
    {
        small: 'e',
        shift: 'E',
        code: 'KeyE',
    },
    {
        small: 'r',
        shift: 'R',
        code: 'KeyR',
    },
    {
        small: 't',
        shift: 'T',
        code: 'KeyT',
    },
    {
        small: 'y',
        shift: 'Y',
        code: 'KeyY',
    },
    {
        small: 'u',
        shift: 'U',
        code: 'KeyU',
    },
    {
        small: 'i',
        shift: 'I',
        code: 'KeyI',
    },
    {
        small: 'o',
        shift: 'O',
        code: 'KeyO',
    },
    {
        small: 'p',
        shift: 'P',
        code: 'KeyP',
    },
    {
        small: '[',
        shift: '{',
        code: 'BracketLeft',
    },
    {
        small: ']',
        shift: '}',
        code: 'BracketRight',
    },
    {
        small: 'Enter',
        shift: null,
        code: 'Enter',
    },
    {
        small: 'CapsLock',
        shift: null,
        code: 'CapsLock',
    },
    {
        small: 'a',
        shift: 'A',
        code: 'KeyA',
    },
    {
        small: 's',
        shift: 'S',
        code: 'KeyS',
    },
    {
        small: 'd',
        shift: 'D',
        code: 'KeyD',
    },
    {
        small: 'f',
        shift: 'F',
        code: 'KeyF',
    },
    {
        small: 'g',
        shift: 'G',
        code: 'KeyG',
    },
    {
        small: 'h',
        shift: 'H',
        code: 'KeyH',
    },
    {
        small: 'j',
        shift: 'J',
        code: 'KeyJ',
    },
    {
        small: 'k',
        shift: 'K',
        code: 'KeyK',
    },
    {
        small: 'l',
        shift: 'L',
        code: 'KeyL',
    },
    {
        small: ';',
        shift: ':',
        code: 'Semicolon',
    },
    {
        small: "'",
        shift: '"',
        code: 'Quote',
    },
    {
        small: '\\',
        shift: '|',
        code: 'Backslash',
    },
    {
        small: 'Shift',
        shift: null,
        code: 'ShiftLeft',
    },
    {
        small: 'z',
        shift: 'Z',
        code: 'KeyZ',
    },
    {
        small: 'x',
        shift: 'X',
        code: 'KeyX',
    },
    {
        small: 'c',
        shift: 'C',
        code: 'KeyC',
    },
    {
        small: 'v',
        shift: 'V',
        code: 'KeyV',
    },
    {
        small: 'b',
        shift: 'B',
        code: 'KeyB',
    },
    {
        small: 'n',
        shift: 'N',
        code: 'KeyN',
    },
    {
        small: 'm',
        shift: 'M',
        code: 'KeyM',
    },
    {
        small: ',',
        shift: '<',
        code: 'Comma',
    },
    {
        small: '.',
        shift: '>',
        code: 'Period',
    },
    {
        small: '/',
        shift: '?',
        code: 'Slash',
    },
    {
        small: 'Shift',
        shift: null,
        code: 'ShiftRight',
    },
    {
        small: ' ',
        shift: null,
        code: 'Space',
    },
    {
        small: '&larr;',
        shift: null,
        code: 'ArrowLeft',
    },
    {
        small: '&uarr;',
        shift: null,
        code: 'ArrowUp',
    },
    {
        small: '&darr;',
        shift: null,
        code: 'ArrowDown',
    },
    {
        small: '&rarr;',
        shift: null,
        code: 'ArrowRight',
    },
    {
        small: `<i class="material-icons">check_circle</i>`,
        shift: null,
        code: 'Done',
    },
    {
        small: 'EN',
        shift: null,
        code: 'Lang',
    },
];

const ru = [
    {
        small: 'CapsLock',
        shift: null,
        code: 'CapsLock',
    },
    {
        small: 'ё',
        shift: 'Ё',
        code: 'Backquote',
    },
    {
        small: '1',
        shift: '!',
        code: 'Digit1',
    },
    {
        small: '2',
        shift: '"',
        code: 'Digit2',
    },
    {
        small: '3',
        shift: '№',
        code: 'Digit3',
    },
    {
        small: '4',
        shift: ';',
        code: 'Digit4',
    },
    {
        small: '5',
        shift: '%',
        code: 'Digit5',
    },
    {
        small: '6',
        shift: ':',
        code: 'Digit6',
    },
    {
        small: '7',
        shift: '?',
        code: 'Digit7',
    },
    {
        small: '8',
        shift: '*',
        code: 'Digit8',
    },
    {
        small: '9',
        shift: '(',
        code: 'Digit9',
    },
    {
        small: '0',
        shift: ')',
        code: 'Digit0',
    },
    {
        small: '-',
        shift: '_',
        code: 'Minus',
    },
    {
        small: '=',
        shift: '+',
        code: 'Equal',
    },
    {
        small: 'Backspace',
        shift: null,
        code: 'Backspace',
    },
    {
        small: 'Delete',
        shift: null,
        code: 'Delete',
    },
    {
        small: 'Tab',
        shift: null,
        code: 'Tab',
    },
    {
        small: 'й',
        shift: 'Й',
        code: 'KeyQ',
    },
    {
        small: 'ц',
        shift: 'Ц',
        code: 'KeyW',
    },
    {
        small: 'у',
        shift: 'У',
        code: 'KeyE',
    },
    {
        small: 'к',
        shift: 'К',
        code: 'KeyR',
    },
    {
        small: 'е',
        shift: 'Е',
        code: 'KeyT',
    },
    {
        small: 'н',
        shift: 'Н',
        code: 'KeyY',
    },
    {
        small: 'г',
        shift: 'Г',
        code: 'KeyU',
    },
    {
        small: 'ш',
        shift: 'Ш',
        code: 'KeyI',
    },
    {
        small: 'щ',
        shift: 'Щ',
        code: 'KeyO',
    },
    {
        small: 'з',
        shift: 'З',
        code: 'KeyP',
    },
    {
        small: 'х',
        shift: 'Х',
        code: 'BracketLeft',
    },
    {
        small: 'ъ',
        shift: 'Ъ',
        code: 'BracketRight',
    },
    {
        small: 'Enter',
        shift: null,
        code: 'Enter',
    },
    {
        small: 'ф',
        shift: 'Ф',
        code: 'KeyA',
    },
    {
        small: 'ы',
        shift: 'Ы',
        code: 'KeyS',
    },
    {
        small: 'в',
        shift: 'В',
        code: 'KeyD',
    },
    {
        small: 'а',
        shift: 'А',
        code: 'KeyF',
    },
    {
        small: 'п',
        shift: 'П',
        code: 'KeyG',
    },
    {
        small: 'р',
        shift: 'Р',
        code: 'KeyH',
    },
    {
        small: 'о',
        shift: 'О',
        code: 'KeyJ',
    },
    {
        small: 'л',
        shift: 'Л',
        code: 'KeyK',
    },
    {
        small: 'д',
        shift: 'Д',
        code: 'KeyL',
    },
    {
        small: 'ж',
        shift: 'Ж',
        code: 'Semicolon',
    },
    {
        small: 'э',
        shift: 'Э',
        code: 'Quote',
    },
    {
        small: '\\',
        shift: '/',
        code: 'Backslash',
    },
    {
        small: 'Shift',
        shift: null,
        code: 'ShiftLeft',
    },
    {
        small: 'я',
        shift: 'Я',
        code: 'KeyZ',
    },
    {
        small: 'ч',
        shift: 'Ч',
        code: 'KeyX',
    },
    {
        small: 'с',
        shift: 'С',
        code: 'KeyC',
    },
    {
        small: 'м',
        shift: 'М',
        code: 'KeyV',
    },
    {
        small: 'и',
        shift: 'И',
        code: 'KeyB',
    },
    {
        small: 'т',
        shift: 'Т',
        code: 'KeyN',
    },
    {
        small: 'ь',
        shift: 'Ь',
        code: 'KeyM',
    },
    {
        small: 'б',
        shift: 'Б',
        code: 'Comma',
    },
    {
        small: 'ю',
        shift: 'Ю',
        code: 'Period',
    },
    {
        small: '.',
        shift: ',',
        code: 'Slash',
    },
    {
        small: 'Shift',
        shift: null,
        code: 'ShiftRight',
    },
    {
        small: ' ',
        shift: null,
        code: 'Space',
    },
    {
        small: '&larr;',
        shift: null,
        code: 'ArrowLeft',
    },
    {
        small: '&uarr;',
        shift: null,
        code: 'ArrowUp',
    },
    {
        small: '&darr;',
        shift: null,
        code: 'ArrowDown',
    },
    {
        small: '&rarr;',
        shift: null,
        code: 'ArrowRight',
    },
    {
        small: `<i class="material-icons">check_circle</i>`,
        shift: null,
        code: 'Done',
    },
    {
        small: 'RU',
        shift: null,
        code: 'Lang',
    },
];

function create(tagName, classes, children, ...dataAttr) {
    let element = null;
    try {
        element = document.createElement(tagName);
    } catch (error) {
        throw new Error('Unable to create HTMLElement! Give a proper tag name.');
    }

    if (classes) element.classList.add(...classes.split(' '));

    if (children && Array.isArray(children)) {
        children.forEach((child) => element.append(child));
    } else if (children && typeof children === 'string')
        element.innerHTML = children;
    else if (children && typeof children === 'object') element.append(children);

    if (dataAttr.length) {
        dataAttr.forEach(([attrName, attrValue]) => {
            if (
                attrName.match(/value|id|placeholder|cols|rows|autocorrect|spellcheck/)
            ) {
                element.setAttribute(attrName, attrValue);
            } else {
                element.dataset[attrName] = attrValue;
            }
        });
    }

    return element;
}

class Key {
    constructor({ small, shift, code }) {
        this.small = small;
        this.shift = shift;
        this.code = code;
        this.isFnKey = Boolean(
            small.match(
                /Shift|Caps|Alt|Tab|Backspace|Del|Enter|arr|material-icons|EN/
            )
        );

        if (shift && shift.match(/[^a-zA-Zа-яА-ЯёЁ0-9]/)) {
            this.subst = create('div', 'sub', shift);
        } else {
            this.subst = create('div', 'sub', '');
        }
        this.letter = create('div', 'letter', small);

        this.keyContainer = create(
            'div',
            'keyboard__key',
            [this.subst, this.letter],
            ['code', code],
            this.isFnKey ? ['fn', 'true'] : ['fn', 'false']
        );
    }
}

const languages = {};
languages.en = en;
languages.ru = ru;

class Keyboard {
    constructor(keysOrder) {
        this.keysOrder = keysOrder;
        this.keysPressed = {};
        this.isCaps = false;
        this.isShift = false;
        this.isKeyboardOpen = true;
    }

    init() {
        this.keyboardLayout = languages.en;
        this.textarea = create(
            'textarea',
            'use-keyboard-input',
            null,
            ['placeholder', 'Start type something...'],
            ['rows', 5],
            ['cols', 50],
            ['spellcheck', false],
            ['autocorrect', 'off']
        );
        this.keysContainer = create('div', 'keyboard', null, ['language', 'en']);

        document.body.append(this.textarea);
        document.body.append(this.keysContainer);

        this.keysContainer.insertAdjacentHTML('afterbegin', "<div class='note'><p>Клавиатура создана в операционной системе Windows</p></div>");
        this.textarea.addEventListener('focus', () => {
            if (!this.isKeyboardOpen) {
                this.open();
            }
        });

        return this;
    }

    createKeys() {
        this.keyButtons = [];
        this.keysOrder.forEach((row) => {
            const rowElement = create('div', 'keyboard__row', null);
            row.forEach((keyCode) => {
                const keyObj = this.keyboardLayout.find((key) => key.code === keyCode);
                if (keyObj) {
                    const keyButton = new Key(keyObj);
                    this.keyButtons.push(keyButton);
                    rowElement.append(keyButton.keyContainer);
                }
            });
            this.keysContainer.append(rowElement);
        });

        document.addEventListener('keyup', this.eventHandler);
        document.addEventListener('keydown', this.eventHandler);
        this.keysContainer.addEventListener('mousedown', this.preEventHandler);
        this.keysContainer.addEventListener('mouseup', this.preEventHandler);
    }

    open() {
        this.isKeyboardOpen = true;
        this.keysContainer.classList.remove('keyboard--hidden');
    }

    close() {
        this.isKeyboardOpen = false;
        this.keysContainer.classList.add('keyboard--hidden');
        this.textarea.blur();
    }

    resetButtonState = ({
        target: {
            dataset: { code },
        },
    }) => {
        const pressedKey = this.keyButtons.find(
            (keyButton) => keyButton.code === code
        );
        pressedKey.keyContainer.classList.remove('active');
        pressedKey.keyContainer.removeEventListener(
            'mouseleave',
            this.resetButtonState
        );
    };

    preEventHandler = (event) => {
        event.stopPropagation();
        const keyDiv = event.target.closest('.keyboard__key');
        if (!keyDiv) return;
        const {
            dataset: { code },
        } = keyDiv;
        if (!code.match(/CapsLock|Shift/)) {
            keyDiv.addEventListener('mouseleave', this.resetButtonState);
        }
        this.eventHandler({ code, type: event.type });
    };

    eventHandler = (event) => {
        if (event.stopPropagation) event.stopPropagation();
        const { code, type } = event;
        const pressedKeyObj = this.keyButtons.find(
            (keyButton) => keyButton.code === code
        );
        if (!pressedKeyObj) return;
        this.textarea.focus();

        if (type.match(/keydown|mousedown/)) {
            if (type.match(/key/)) event.preventDefault();
            pressedKeyObj.keyContainer.classList.add('active');

            if (code.match(/Shift/)) {
                if (type == 'keydown') {
                    this.isShift = true;
                } else if (type == 'mousedown') {
                    if (!this.isShift) {
                        this.isShift = true;
                    } else {
                        this.isShift = false;
                        pressedKeyObj.keyContainer.classList.remove('active');
                    }
                }
                this.switchUpperCase();
            }

            if (code == 'CapsLock') {
                if (!this.isCaps) {
                    this.isCaps = true;
                } else {
                    this.isCaps = false;
                    pressedKeyObj.keyContainer.classList.remove('active');
                }
                this.switchUpperCase();
            }

            if (code == 'Record') {
                this.toggleRecognition();
                return;
            }

            if (!this.isCaps) {
                this.print(
                    pressedKeyObj,
                    this.isShift ? pressedKeyObj.shift : pressedKeyObj.small
                );
            } else if (this.isCaps) {
                if (this.isShift) {
                    this.print(
                        pressedKeyObj,
                        pressedKeyObj.subst.innerHTML
                            ? pressedKeyObj.shift
                            : pressedKeyObj.small
                    );
                } else if (!this.isShift) {
                    this.print(
                        pressedKeyObj,
                        !pressedKeyObj.subst.innerHTML
                            ? pressedKeyObj.shift
                            : pressedKeyObj.small
                    );
                }
            }
        } else if (type.match(/keyup|mouseup/)) {

            if (!code.match(/CapsLock|Shift/)) {
                pressedKeyObj.keyContainer.classList.remove('active');
            }

            if (code.match(/Shift/) && type == 'keyup') {
                this.isShift = false;
                this.switchUpperCase();
                pressedKeyObj.keyContainer.classList.remove('active');
            }

            if (code == 'Lang') this.switchLanguage();

            if (code == 'Done') {
                this.close();
            }
        }
    };

    switchLanguage() {
        if (this.keysContainer.dataset.language == 'en') {
            this.keysContainer.dataset.language = 'ru';
            this.keyboardLayout = languages.ru;
        } else {
            this.keysContainer.dataset.language = 'en';
            this.keyboardLayout = languages.en;
        }

        this.keyButtons.forEach((button) => {
            const curLangBtn = this.keyboardLayout.find(
                (key) => key.code === button.code
            );
            if (!curLangBtn) return;
            button.small = curLangBtn.small;
            button.shift = curLangBtn.shift;
            if (curLangBtn.shift && curLangBtn.shift.match(/[^a-zA-Zа-яА-ЯёЁ0-9]/g)) {
                button.subst.innerHTML = curLangBtn.shift;
            } else {
                button.subst.innerHTML = '';
            }
            button.letter.innerHTML = curLangBtn.small;
        });
    }

    switchUpperCase() {
        const symbolKeyButtons = this.keyButtons.filter(
            (button) => button.isFnKey === false
        );
        symbolKeyButtons.forEach((button) => {
            if (button.subst.innerHTML) {
                if (this.isShift) {
                    button.subst.classList.add('sub-active');
                    button.letter.classList.add('sub-inactive');
                } else if (!this.isShift) {
                    button.subst.classList.remove('sub-active');
                    button.letter.classList.remove('sub-inactive');
                }
            } else if (!button.subst.innerHTML) {
                if (this.isCaps) {
                    this.isShift
                        ? (button.letter.innerHTML = button.small)
                        : (button.letter.innerHTML = button.shift);
                } else if (!this.isCaps) {
                    this.isShift
                        ? (button.letter.innerHTML = button.shift)
                        : (button.letter.innerHTML = button.small);
                }
            }
        });
    }

    print(keyObj, symbol) {
        let carriagePos = this.textarea.selectionStart;
        const leftArea = this.textarea.value.slice(0, carriagePos);
        const rightArea = this.textarea.value.slice(carriagePos);
        const fnBtnHandler = {
            Tab: () => {
                this.textarea.value = `${leftArea}\t${rightArea}`;
                carriagePos += 1;
            },
            Enter: () => {
                this.textarea.value = `${leftArea}\n${rightArea}`;
                carriagePos += 1;
            },
            Space: () => {
                this.textarea.value = `${leftArea} ${rightArea}`;
                carriagePos += 1;
            },
            Backspace: () => {
                this.textarea.value = `${leftArea.slice(0, -1)}${rightArea}`;
                carriagePos -= 1;
            },
            Delete: () => {
                this.textarea.value = `${leftArea}${rightArea.slice(1)}`;
            },
            ArrowLeft: () => {
                carriagePos = carriagePos - 1 >= 0 ? carriagePos - 1 : 0;
            },
            ArrowRight: () => {
                carriagePos += 1;
            },
            ArrowUp: () => {
                const posFromLineBreak = leftArea.match(/(\n).*$(?!\1)/g) || [[1]];
                carriagePos -= posFromLineBreak[0].length;
            },
            ArrowDown: () => {
                const posFromLineBreak = rightArea.match(/^.*(\n).*(?!\1)/) || [[1]];
                carriagePos += posFromLineBreak[0].length;
            },
            Record: () => {
                this.textarea.value = `${leftArea}${symbol || ''}${rightArea}`;
                carriagePos += symbol.length;
            },
        };

        if (fnBtnHandler[keyObj.code]) fnBtnHandler[keyObj.code]();
        else if (!keyObj.isFnKey) {
            this.textarea.value = `${leftArea}${symbol || ''}${rightArea}`;
            carriagePos += 1;
        }
        this.textarea.setSelectionRange(carriagePos, carriagePos);
    }
}
const keysOrder = [
    [
        'Backquote',
        'Digit1',
        'Digit2',
        'Digit3',
        'Digit4',
        'Digit5',
        'Digit6',
        'Digit7',
        'Digit8',
        'Digit9',
        'Digit0',
        'Minus',
        'Equal',
        'Backspace',
    ],
    [
        'Tab',
        'KeyQ',
        'KeyW',
        'KeyE',
        'KeyR',
        'KeyT',
        'KeyY',
        'KeyU',
        'KeyI',
        'KeyO',
        'KeyP',
        'BracketLeft',
        'BracketRight',
        'Backslash',
        'Delete',
    ],
    [
        'CapsLock',
        'KeyA',
        'KeyS',
        'KeyD',
        'KeyF',
        'KeyG',
        'KeyH',
        'KeyJ',
        'KeyK',
        'KeyL',
        'Semicolon',
        'Quote',
        'Enter',
    ],
    [
        'ShiftLeft',
        'KeyZ',
        'KeyX',
        'KeyC',
        'KeyV',
        'KeyB',
        'KeyN',
        'KeyM',
        'Comma',
        'Period',
        'Slash',
        'ArrowUp',
        'ShiftRight',
    ],
    [
        'Done',
        'Lang',
        'Space',
        'AltRight',
        'ArrowLeft',
        'ArrowDown',
        'ArrowRight',
        'Record',
    ],
];

new Keyboard(keysOrder).init().createKeys();